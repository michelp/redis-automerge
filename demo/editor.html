<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redis-Automerge Collaborative Editor Demo</title>
    <link rel="stylesheet" href="editor-style.css">
</head>
<body>
    <h1>Redis-Automerge Collaborative Editor</h1>

    <!-- Tab Selector -->
    <div id="mode-selector" class="tab-container">
        <button class="tab-btn active" data-mode="dual" onclick="switchMode('dual')">
            Dual Editor Mode
        </button>
        <button class="tab-btn" data-mode="shareable" onclick="switchMode('shareable')">
            Shareable Link Mode
        </button>
    </div>

    <!-- Dual Editor Mode Panel (existing content) -->
    <div id="dual-mode" class="mode-panel active">
        <div class="header">
            <p>Real-time CRDT synchronization with Automerge</p>
            <div class="controls">
            <input type="text" id="doc-key" placeholder="Document key" value="collab-doc">
            <button id="create-btn" onclick="initializeDocument()">Create New Document</button>
            <button id="connect-btn" onclick="connectEditors()">Connect Editors</button>
            <button onclick="window.location.href='index.html'">‚Üê Back to Main Demo</button>
        </div>
        <div class="status-bar">
            <span id="connection-status" class="status-disconnected">Disconnected</span>
            <span id="sync-status">Not syncing</span>
            <span id="doc-version-left">Left: v0</span>
            <span id="doc-version-right">Right: v0</span>
        </div>
    </div>

    <div class="editor-container">
        <div class="editor-pane">
            <div class="pane-header">
                <h2>Editor A</h2>
                <span id="peer-id-left" class="peer-id">Peer ID: ...</span>
            </div>
            <div class="editor-wrapper">
                <textarea id="editor-left" placeholder="Start typing..."></textarea>
            </div>
            <div class="info-panel">
                <h3>Local State</h3>
                <div id="info-left" class="info-content"></div>
            </div>
        </div>

        <div class="sync-indicator">
            <div class="sync-arrow">‚ü∑</div>
            <div class="sync-label">Real-time Sync</div>
        </div>

        <div class="editor-pane">
            <div class="pane-header">
                <h2>Editor B</h2>
                <span id="peer-id-right" class="peer-id">Peer ID: ...</span>
            </div>
            <div class="editor-wrapper">
                <textarea id="editor-right" placeholder="Start typing..."></textarea>
            </div>
            <div class="info-panel">
                <h3>Local State</h3>
                <div id="info-right" class="info-content"></div>
            </div>
        </div>
    </div>

    <div class="log-container">
        <div class="log-header">
            <h3>Sync Log</h3>
            <button onclick="selectAllLog()">Select All</button>
            <button onclick="clearLog()">Clear</button>
        </div>
        <div id="sync-log" class="sync-log"></div>
    </div>

    <div class="instructions">
            <h3>How It Works</h3>
            <ol>
                <li><strong>Create Document:</strong> Initialize a new Automerge document in Redis</li>
                <li><strong>Connect Editors:</strong> Both editors sync with Redis and subscribe to changes</li>
                <li><strong>Type in Either Editor:</strong> Changes are automatically synced via Redis Pub/Sub</li>
                <li><strong>Local-First:</strong> Each editor maintains its own Automerge document copy</li>
                <li><strong>Conflict Resolution:</strong> Automerge CRDT handles concurrent edits automatically</li>
            </ol>
            <p><strong>Try it:</strong> Type in both editors simultaneously to see conflict-free merging in action!</p>
        </div>
    </div>

    <!-- Shareable Editor Mode Panel (new) -->
    <div id="shareable-mode" class="mode-panel hidden">
        <!-- Left Sidebar: Room List & Management -->
        <div class="room-sidebar">
            <h3>Rooms</h3>

            <div class="room-list-container">
                <div id="room-list" class="room-list">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="room-management">
                <h4>Create Room</h4>
                <button onclick="ShareableMode.createRandomRoom()">
                    üé≤ Random Room
                </button>
                <input id="custom-room-name" type="text" placeholder="Custom room name">
                <button onclick="ShareableMode.createCustomRoom()">
                    ‚úèÔ∏è Create Custom
                </button>
                <button onclick="ShareableMode.refreshRoomList()" style="background: #10b981;">
                    üîÑ Refresh List
                </button>
            </div>
        </div>

        <!-- Center: Editor -->
        <div id="editor-container-shareable" class="editor-main">
            <div class="editor-toolbar">
                <div class="room-info">
                    <span>Room: <strong id="current-room-name">Not connected</strong></span>
                    <span id="peer-id-shareable" class="peer-id"></span>
                </div>
                <div class="toolbar-actions">
                    <button onclick="ShareableMode.copyShareableLink()" class="action-button">
                        üìã Copy Link
                    </button>
                </div>
            </div>

            <div class="editor-content">
                <textarea id="editor-shareable" placeholder="Select a room or create a new one to start editing..."></textarea>
                <div class="editor-status-footer">
                    <span id="connection-status-shareable-editor" class="status-disconnected">Disconnected</span>
                    <span id="sync-status-shareable-editor">Not syncing</span>
                    <span id="doc-version-shareable" class="doc-version"></span>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: History -->
        <div class="history-sidebar">
            <h3>History</h3>
            <div class="history-container">
                <div id="history-list" class="history-list">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Use Automerge from CDN - Using the stable 1.x version for browser compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/automerge@1.0.1-preview.7/dist/automerge.js"></script>
    <script src="editor-app.js" defer></script>
</body>
</html>
